@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS
@rendermode InteractiveWebAssembly

<!-- Add compact horizontal emoji tab -->
<style>
    .emoji-container {
        display: flex;
        gap: 6px;
        padding: 4px 6px;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
    }
    /* Render menu items inline and compact */
    .emoji-menu .mud-menu-item {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 34px;
        height: 34px;
        padding: 4px 6px;
        border-radius: 6px;
        font-size: 1.15rem;
    }
    .emoji-menu .mud-menu-item:hover {
        background-color: rgba(0,0,0,0.06);
    }
    /* Tighter menu paper */
    .emoji-menu .mud-paper {
        padding: 4px 6px;
    }
    /* Nudge the popover so it sits adjacent to the emoji button */
    .emoji-menu .mud-popover {
        transform: translate(-4px, 2px) !important;
    }

    /* popover to place bar directly beneath the button */
    .emoji-wrapper { position: relative; display: inline-block; }
    .emoji-popover {
        position: absolute;
        top: 40px;               /* distance below the button */
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 6px;
        padding: 6px 8px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 6px 18px rgba(0,0,0,0.12);
        z-index: 1200;
        white-space: nowrap;
    }
    .emoji-popover .emoji-button {
        border: none;
        background: transparent;
        font-size: 1.15rem;
        height: 34px;
        width: 34px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        cursor: pointer;
        padding: 0;
    }
    .emoji-popover .emoji-button:hover {
        background: rgba(0,0,0,0.06);
    }
</style>

<MudContainer @onclick="() => showEmojiPicker = false" Class="mt-6 d-flex flex-column gap-4 align-items-start" Style="width:100%; padding-bottom: 5rem;">
    <AuthorizeView>
        <Authorized>
            <MudCard Class="p-3" Style="width:45rem">
                <div class="d-flex gap-2">
                    <MudAvatar Color="Color.Secondary">@context.User.Identity?.Name[0]</MudAvatar>
                    <textarea 
                        class="w-100 pt-2"
                        style="outline: none; resize: none; font-size: 1rem;"
                        @bind="newPostContent"
                        @ref="postTextarea"
                        rows="5"
                        placeholder="What's growing on?">
                    </textarea>
                </div>
                
                <div class="d-flex justify-content-between align-items-center">
                    <!-- remove gap so emoji button sits right next to image button -->
                    <div class="d-flex align-items-center gap-0">
                        <MudIconButton Icon="@Icons.Material.Filled.Image" />

                        <div class="emoji-wrapper ms-2">
                            <MudIconButton Icon="@Icons.Material.Filled.SentimentSatisfied" OnClick="@(()=> showEmojiPicker = !showEmojiPicker)" />

                            @if (showEmojiPicker)
                            {
                                <div class="emoji-popover" @onclick:stopPropagation>
                                    @foreach (var emoji in emojis)
                                    {
                                        <button class="emoji-button" @onclick="async ()=> { await InsertEmoji(emoji); }">@emoji</button>
                                    }
                                </div>
                            }
                        </div>
                    </div>

                    <MudButton OnClick="AddPost" Color="Color.Primary" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.PostAdd">
                        Post
                    </MudButton>
                </div>
            </MudCard>
        </Authorized>
    </AuthorizeView>

    @foreach (var post in posts.AsEnumerable().Reverse())
    {
        <MudCard Class="p-3 bg-white" Style="cursor: pointer; width:45rem;">
            <div class="d-flex">
                <MudAvatar Style="margin-right: 0.5rem;" Color="Color.Primary">@post.Poster[0]</MudAvatar>
                <div class="mt-1 w-100">
                    <MudText Typo="Typo.body1">
                        @post.Poster
                    </MudText>
                    
                    <MudText Class="opacity-75 w-100" Typo="Typo.body2">
                        @post.Content
                    </MudText>

                    <div class="mt-4 d-flex justify-content-between align-items-center">
                        <div>
                            <MudButton>
                                <MudIcon Style="margin-right: 0.3rem;" Icon="@Icons.Material.Filled.Favorite" Size="Size.Small"/>
                                <span>@post.Likes</span>
                            </MudButton>

                            <MudButton>
                                <MudIcon Style="margin-right: 0.3rem;" Icon="@Icons.Material.Filled.Comment" Size="Size.Small"/>
                                <span>@post.Comments</span>
                            </MudButton>
                        </div>

                        <MudButton>
                            <MudIcon Icon="@Icons.Material.Filled.Download" Size="Size.Small"/>
                        </MudButton>
                    </div>
                </div>
            </div>
        </MudCard>
    }
</MudContainer>

@code {
    private List<Post> posts = new()
    {
        new Post
        {
            Content = "Just harvested my first batch of organic tomatoes! üçÖüåø #FarmLife #OrganicFarming",
            Poster = "Alice",
            Likes = 30,
            Comments = 7
        },
        new Post
        {
            Content = "Excited to announce that our farm will be hosting a community market this weekend! üõíüåΩ #SupportLocal #FarmersMarket",
            Poster = "Bob",
            Likes = 45,
            Comments = 12
        },
    };

    private string newPostContent = string.Empty;
    private ElementReference postTextarea;
    private bool showEmojiPicker = false;

    private readonly List<string> emojis = new()
    {
        "üòÄ","üòÇ","üòç","üòÖ","üòé","üòä","üòâ","ü§©","üò≠","üëç"
    };

    private async Task AddPost()
    {
        if (!string.IsNullOrWhiteSpace(newPostContent))
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userName = authState.User.Identity?.Name ?? "Unknown";

            posts.Add(new Post
            {
                Content = newPostContent,
                Poster = userName,
                Likes = 0,
                Comments = 0
            });

            newPostContent = string.Empty;
            await Task.Yield();
        }
    }

    // Insert emoji at caret position using JS helper; close picker after insert.
    private async Task InsertEmoji(string emoji)
    {
        try
        {
            var updated = await JS.InvokeAsync<string>("insertEmojiAtCursor", postTextarea, emoji + " ");
            if (!string.IsNullOrEmpty(updated))
                newPostContent = updated;
            else
                newPostContent += emoji + " ";
        }
        catch
        {
            newPostContent += emoji + " ";
        }
        showEmojiPicker = false;
    }

    private class Post
    {
        public string Content { get; set; } = string.Empty;
        public string Poster { get; set; } = string.Empty;
        public int Likes { get; set; }
        public int Comments { get; set; }
    }
}

<script>
    // JS helper to insert emoji at caret and return updated value (works with ElementReference)
    window.insertEmojiAtCursor = (el, emoji) => {
        if (!el) return "";
        try {
            const start = el.selectionStart ?? el.value.length;
            const end = el.selectionEnd ?? el.value.length;
            const before = el.value.substring(0, start);
            const after = el.value.substring(end);
            const newVal = before + emoji + after;
            el.value = newVal;
            const caret = start + emoji.length;
            el.selectionStart = el.selectionEnd = caret;
            // dispatch input event so Blazor binding updates if present
            const evt = new Event('input', { bubbles: true });
            el.dispatchEvent(evt);
            el.focus();
            return newVal;
        } catch (e) {
            return el.value || "";
        }
    };
</script>