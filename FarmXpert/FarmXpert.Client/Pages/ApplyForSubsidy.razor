@page "/apply-for-subsidy"
@using FarmXpert.Client.Components
@inject HttpClient Http
@rendermode InteractiveWebAssembly

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-6">
    <MudText Typo="Typo.h4" Class="fw-bold" GutterBottom="true">Apply for Subsidy</MudText>
</MudContainer>

<MudContainer Class="mt-6 pb-5">
    @if (_selectDisabled)
    {
        <MudText Class="mb-2 text-danger" Typo="Typo.body2">
            You cannot select a subsidy type until you complete your profile setup.
        </MudText>
    }

    <MudSelect @bind-Value="_value"
               Variant="Variant.Filled"
               Label="Subsidy Type"
               Disabled="@_selectDisabled">
        @foreach (var type in _subsidyTypes)
        {
            <MudSelectItem Value="type">@type</MudSelectItem>
        }
    </MudSelect>

    @if (_value == "Advance payments")
    { 
        <AdvancePayments/>
    }
    else if (_value == "Complementary payments")
    {
        <ComplementaryPayments/>
    }
    else if (_value == "Direct payments")
    {
        <DirectPayments/>
    }
    else if (_value == "Payments of investments in stages")
    {
        <PaymentsOfInvestmentsInStages/> 
    }

    else if (_value == "Post-investment payments")
    {
        <PostInvestmentPayments/> 
    }
    
</MudContainer>

@code {
    private string _value;
    IList<IBrowserFile> _files = new List<IBrowserFile>();
    private bool _selectDisabled = true;
    private bool isLoading = true;

    private readonly string[] _subsidyTypes =
    {
        "Advance payments", 
        "Complementary payments",
        "Direct payments", 
        "Payments of investments in stages",
        "Post-investment payments"
    };

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var result = await Http.GetFromJsonAsync<ProfileStatus>("api/users/profile-status");
            _selectDisabled = !(result?.ProfileSetupCompleted ?? false);
        }
        catch
        {
            _selectDisabled = true;
        }
        finally
        {
            isLoading = false;
        }
    }

    private void UploadFiles(IBrowserFile file)
    {
        _files.Add(file);
        //TODO upload the files to the server
    }

    private class ProfileStatus
    {
        public bool ProfileSetupCompleted { get; set; }
    }
}
