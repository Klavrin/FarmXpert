@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS
@rendermode InteractiveWebAssembly

<MudContainer Class="mt-6 d-flex flex-column gap-4 align-items-start" Style="width:100%; padding-bottom: 5rem;">
    <AuthorizeView>
        <Authorized>
            <MudCard Class="p-3" Style="width:45rem">
                <div class="d-flex gap-2">
                    <MudAvatar Color="Color.Secondary">@context.User.Identity?.Name[0]</MudAvatar>
                    <textarea 
                        @ref="postTextarea"
                        class="w-100 pt-2"
                        style="outline: none; resize: none; font-size: 1rem;"
                        @bind="newPostContent"
                        rows="5"
                        placeholder="What's growing on?">
                    </textarea>
                </div>
                
                <div class="d-flex justify-content-between align-items-center" style="position:relative;">
                    <div class="d-flex align-items-center gap-1">
                        <MudIconButton Icon="@Icons.Material.Filled.Image"/>
                        <!-- smile face emoji picker toggle -->
                        <MudIconButton Icon="@Icons.Material.Filled.SentimentSatisfied" OnClick="ToggleEmojiPicker" AriaLabel="Emoji picker"/>
                    </div>

                    <MudButton OnClick="AddPost" Color="Color.Primary" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.PostAdd">
                        Post
                    </MudButton>

                    @if (showEmojiPicker)
                    {
                        <div style="position:absolute; left:3.5rem; bottom:3rem; z-index:60; background:white; border:1px solid rgba(0,0,0,0.12); border-radius:6px; padding:8px; box-shadow:0 8px 16px rgba(0,0,0,0.08);">
                            <div style="display:grid; grid-template-columns:repeat(8,1fr); gap:6px; max-width:320px;">
                                @foreach (var e in emojis)
                                {
                                    <button class="mud-button-root mud-button-text" style="font-size:18px; padding:6px; border-radius:6px; background:transparent; border:none; cursor:pointer;" @onclick="() => SelectEmoji(e)">
                                        @e
                                    </button>
                                }
                            </div>
                        </div>
                    }
                </div>
            </MudCard>
        </Authorized>
    </AuthorizeView>

    @foreach (var post in posts.AsEnumerable().Reverse())
    {
        <MudCard Class="p-3 bg-white" Style="cursor: pointer; width:45rem;">
            <div class="d-flex">
                <MudAvatar Style="margin-right: 0.5rem;" Color="Color.Primary">@post.Poster[0]</MudAvatar>
                <div class="mt-1 w-100">
                    <MudText Typo="Typo.body1">
                        @post.Poster
                    </MudText>
                    
                    <MudText Class="opacity-75 w-100" Typo="Typo.body2">
                        @post.Content
                    </MudText>

                    <div class="mt-4 d-flex justify-content-between align-items-center">
                        <div>
                            <MudButton>
                                <MudIcon Style="margin-right: 0.3rem;" Icon="@Icons.Material.Filled.Favorite" Size="Size.Small"/>
                                <span>@post.Likes</span>
                            </MudButton>

                            <MudButton>
                                <MudIcon Style="margin-right: 0.3rem;" Icon="@Icons.Material.Filled.Comment" Size="Size.Small"/>
                                <span>@post.Comments</span>
                            </MudButton>
                        </div>

                        <MudButton>
                            <MudIcon Icon="@Icons.Material.Filled.Download" Size="Size.Small"/>
                        </MudButton>
                    </div>
                </div>
            </div>
        </MudCard>
    }
</MudContainer>

@code {
    private List<Post> posts = new()
    {
        new Post
        {
            Content = "Just harvested my first batch of organic tomatoes! ğŸ…ğŸŒ¿ #FarmLife #OrganicFarming",
            Poster = "Alice",
            Likes = 30,
            Comments = 7
        },
        new Post
        {
            Content = "Excited to announce that our farm will be hosting a community market this weekend! ğŸ›’ğŸŒ½ #SupportLocal #FarmersMarket",
            Poster = "Bob",
            Likes = 45,
            Comments = 12
        },
    };

    private string newPostContent = string.Empty;
    private ElementReference postTextarea;
    private bool showEmojiPicker = false;
    private readonly string[] emojis = new[]
    {
        "ğŸ˜€","ğŸ˜","ğŸ˜‚","ğŸ¤£","ğŸ˜Š","ğŸ˜‡","ğŸ™‚","ğŸ˜‰","ğŸ˜","ğŸ˜˜","ğŸ˜œ","ğŸ¤ª","ğŸ¤©","ğŸ˜",
        "ğŸ˜­","ğŸ˜¡","ğŸ˜…","ğŸ‘","ğŸ‘","ğŸŒ½","ğŸ…","ğŸŒ±","ğŸŒ¾","ğŸ§‘â€ğŸŒ¾"
    };

    private async Task AddPost()
    {
        if (!string.IsNullOrWhiteSpace(newPostContent))
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userName = authState.User.Identity?.Name ?? "Unknown";

            posts.Add(new Post
            {
                Content = newPostContent,
                Poster = userName,
                Likes = 0,
                Comments = 0
            });

            newPostContent = string.Empty;
        }
    }

    private void ToggleEmojiPicker()
    {
        showEmojiPicker = !showEmojiPicker;
    }

    private async Task SelectEmoji(string emoji)
    {
        // insert emoji at caret via JS and get updated value back
        var updated = await JS.InvokeAsync<string>("insertEmojiAtCursor", postTextarea, emoji);
        newPostContent = updated;
        showEmojiPicker = false;
        StateHasChanged();
        await Task.Yield();
    }

    private class Post
    {
        public string Content { get; set; } = string.Empty;
        public string Poster { get; set; } = string.Empty;
        public int Likes { get; set; }
        public int Comments { get; set; }
    }
}
<script>
    // JS helper to insert emoji at caret and return updated value (works with ElementReference)
    window.insertEmojiAtCursor = (el, emoji) => {
        if (!el) return "";
        try {
            const start = el.selectionStart ?? el.value.length;
            const end = el.selectionEnd ?? el.value.length;
            const before = el.value.substring(0, start);
            const after = el.value.substring(end);
            const newVal = before + emoji + after;
            el.value = newVal;
            const caret = start + emoji.length;
            el.selectionStart = el.selectionEnd = caret;
            // dispatch input event so Blazor binding updates if present
            const evt = new Event('input', { bubbles: true });
            el.dispatchEvent(evt);
            el.focus();
            return newVal;
        } catch (e) {
            return el.value;
        }
    };
</script>